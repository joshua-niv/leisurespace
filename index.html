<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lowe's ç­”é¢˜æ´»åŠ¨</title>
  <!-- Tailwindï¼ˆCDN ç‰ˆï¼Œå¯æ›¿æ¢ä¸ºæœ¬åœ°æ–‡ä»¶ä»¥å®Œå…¨ç¦»çº¿ï¼‰-->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <!-- QRCode ç”Ÿæˆåº“ï¼ˆçº¯å‰ç«¯ï¼Œæ— å¤–éƒ¨æœåŠ¡ä¾èµ–ï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <!-- Confetti åŠ¨æ•ˆï¼ˆå‰ç«¯å½©å¸¦ï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <!-- LeanCloud JS SDKï¼ˆä¸­å›½åŒºå¯ç”¨ï¼Œé¿å… Google ä¾èµ–ï¼‰-->
  <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4/dist/av-min.js"></script>

  <style>
    /* Lowe's å“ç‰Œé…è‰² */
    :root {
      --lowes-blue: #004990;
      --lowes-red: #DC143C;
      --lowes-light-blue: #0066CC;
      --lowes-gray: #666666;
      --lowes-light-gray: #F5F5F5;
    }
    
    .big-shadow { box-shadow: 0 20px 50px rgba(0,0,0,0.15); }
    
    /* Lowe's ä¸»æŒ‰é’®æ ·å¼ */
    .btn-lowes-primary {
      background-color: var(--lowes-blue);
      color: white;
      transition: background-color 0.3s ease;
    }
    .btn-lowes-primary:hover {
      background-color: var(--lowes-light-blue);
    }
    
    .btn-lowes-secondary {
      background-color: var(--lowes-red);
      color: white;
      transition: background-color 0.3s ease;
    }
    .btn-lowes-secondary:hover {
      background-color: #B9122E;
    }
    
    /* Lowe's Logo æ ·å¼ */
    .lowes-logo {
      fill: var(--lowes-blue);
      width: 120px;
      height: auto;
    }
    
    /* è¾“å…¥æ¡†æ ·å¼ */
    .input-lowes {
      border: 2px solid #ddd;
      transition: border-color 0.3s ease;
    }
    .input-lowes:focus {
      outline: none;
      border-color: var(--lowes-blue);
    }
    
    /* é¢˜ç›®é€‰é¡¹æŒ‰é’®æ ·å¼ */
    .option-btn {
      border: 2px solid #e0e0e0;
      transition: all 0.3s ease;
    }
    .option-btn:hover {
      border-color: var(--lowes-blue);
      background-color: rgba(0, 73, 144, 0.05);
      transform: translateY(-2px);
    }
    
    /* å¡ç‰‡æ ·å¼ä¼˜åŒ– */
    .card-lowes {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
      background: linear-gradient(to bottom, #f8f9fa 0%, #e9ecef 100%);
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-900">
  <div class="max-w-4xl mx-auto p-6">
    <!-- Lowe's Logo -->
    <div class="flex justify-center mb-6">
      <svg class="lowes-logo" viewBox="0 0 200 60" xmlns="http://www.w3.org/2000/svg">
        <!-- Lowe's Logo æ–‡å­—éƒ¨åˆ† -->
        <text x="10" y="40" font-family="Arial, sans-serif" font-size="36" font-weight="bold" fill="#004990">Lowe's</text>
        <!-- è£…é¥°æ€§çº¢çº¿ -->
        <rect x="10" y="45" width="100" height="4" fill="#DC143C"/>
      </svg>
    </div>
    <h1 class="text-3xl font-bold mb-6 text-center" style="color: var(--lowes-blue);">ç­”é¢˜æ´»åŠ¨</h1>

    <!-- å‚ä¸ç«¯ï¼šå¡«å†™å§“å -->
    <section id="view-join" class="hidden">
      <div class="card-lowes p-8 big-shadow">
        <h2 class="text-2xl font-semibold mb-6" style="color: var(--lowes-blue);">â‘  å¡«å†™å§“åå‚ä¸</h2>
        <div class="flex space-x-3 mb-4">
          <input id="nameInput" class="input-lowes flex-1 rounded-lg px-4 py-3 text-lg" placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å" />
          <button id="nameBtn" class="btn-lowes-primary px-6 py-3 rounded-lg font-semibold">æäº¤</button>
        </div>
        <p class="text-sm" style="color: var(--lowes-gray);">æäº¤åè¯·ç­‰å¾…ä¸»æŒäººå¼€æ”¾ç¬¬1é¢˜ã€‚</p>
      </div>
    </section>

    <!-- å‚ä¸ç«¯ï¼šç¬¬1é¢˜ -->
    <section id="view-q1" class="hidden">
      <div class="card-lowes p-8 big-shadow">
        <h2 id="q1Title" class="text-2xl font-semibold mb-6" style="color: var(--lowes-blue);">ç¬¬1é¢˜</h2>
        <div id="q1Opts"></div>
        <p class="text-sm mt-4" style="color: var(--lowes-gray);">é€‰æ‹©åå³æäº¤ï¼Œè¯·ä»”ç»†ä½œç­”ã€‚</p>
      </div>
    </section>

    <!-- å‚ä¸ç«¯ï¼šç¬¬2é¢˜ -->
    <section id="view-q2" class="hidden">
      <div class="card-lowes p-8 big-shadow">
        <h2 id="q2Title" class="text-2xl font-semibold mb-6" style="color: var(--lowes-blue);">ç¬¬2é¢˜</h2>
        <div id="q2Opts"></div>
        <p class="text-sm mt-4" style="color: var(--lowes-gray);">é€‰æ‹©åå³æäº¤ï¼Œè¯·ä»”ç»†ä½œç­”ã€‚</p>
      </div>
    </section>

    <!-- å‚ä¸ç«¯ï¼šç­‰å¾…åŒº -->
    <section id="view-wait" class="hidden">
      <div class="card-lowes p-8 big-shadow text-center">
        <div class="mb-4">
          <div class="inline-block w-16 h-16 border-4 border-t-transparent rounded-full animate-spin" style="border-color: var(--lowes-blue); border-top-color: transparent;"></div>
        </div>
        <h2 class="text-2xl font-semibold mb-4" style="color: var(--lowes-blue);">è¯·ç¨å€™</h2>
        <p id="waitMsg" class="text-lg mb-4" style="color: var(--lowes-gray);">ä¸»æŒäººç¨åå°†å¼€å¯é¢˜ç›®æˆ–å…¬å¸ƒæŠ½å¥–ç»“æœâ€¦</p>
        <div class="mt-4 text-gray-700">æ‚¨çš„å§“åï¼š
          <span id="yourName" class="font-bold text-lg" style="color: var(--lowes-blue);"></span>
        </div>
      </div>
    </section>

    <!-- å¤§å±å¹•æ¨¡å¼ -->
    <section id="view-screen" class="hidden">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="card-lowes p-8 big-shadow flex flex-col items-center justify-center">
          <div id="screenQR" class="mb-6"></div>
          <div class="text-xl font-semibold" style="color: var(--lowes-blue);">è¯·æ‰«ç å‚ä¸ç­”é¢˜</div>
        </div>
        <div class="card-lowes p-8 big-shadow">
          <div class="text-4xl font-extrabold mb-4" style="color: var(--lowes-blue);">ç°åœºè¿›åº¦</div>
          <div id="screenMsg" class="text-2xl mb-6 font-semibold" style="color: var(--lowes-gray);">ç­‰å¾…å¼€å§‹â€¦</div>
          <div class="grid grid-cols-3 gap-4 text-center">
            <div class="p-6 border-2 rounded-xl" style="border-color: var(--lowes-blue);">
              <div class="text-4xl font-bold mb-2" style="color: var(--lowes-blue);" id="screenTotal">0</div>
              <div class="text-sm font-semibold" style="color: var(--lowes-gray);">æŠ¥åäººæ•°</div>
            </div>
            <div class="p-6 border-2 rounded-xl" style="border-color: var(--lowes-blue);">
              <div class="text-4xl font-bold mb-2" style="color: var(--lowes-blue);" id="screenQ1">0</div>
              <div class="text-sm font-semibold" style="color: var(--lowes-gray);">ç¬¬1é¢˜æäº¤</div>
            </div>
            <div class="p-6 border-2 rounded-xl" style="border-color: var(--lowes-blue);">
              <div class="text-4xl font-bold mb-2" style="color: var(--lowes-blue);" id="screenQ2">0</div>
              <div class="text-sm font-semibold" style="color: var(--lowes-gray);">ç¬¬2é¢˜æäº¤</div>
            </div>
          </div>
        </div>
      </div>

      <div class="card-lowes p-8 mt-6 big-shadow text-center" style="background: linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%); border: 3px solid var(--lowes-red);">
        <div class="text-5xl mb-4">ğŸ‰</div>
        <div class="text-4xl font-extrabold mb-2" style="color: var(--lowes-red);">æ­å–œ <span class="winnerName"></span> ï¼</div>
        <div style="color: var(--lowes-gray);" class="text-lg mt-2">ï¼ˆå½“ä¸»æŒäººæŠ½å¥–åå°†æ˜¾ç¤ºï¼‰</div>
      </div>
    </section>

    <!-- ç®¡ç†å‘˜æ¨¡å¼ -->
    <section id="view-admin" class="hidden">
      <div id="adminGate" class="card-lowes p-8 big-shadow">
        <h2 class="text-2xl font-semibold mb-6" style="color: var(--lowes-blue);">ç®¡ç†å‘˜å…¥å£</h2>
        <div class="flex space-x-3">
          <input id="adminCode" class="input-lowes flex-1 rounded-lg px-4 py-3 text-lg" placeholder="è¾“å…¥ç®¡ç†å‘˜å£ä»¤" />
          <button id="adminEnter" class="btn-lowes-primary px-6 py-3 rounded-lg font-semibold">è¿›å…¥</button>
        </div>
      </div>

      <div id="adminPanel" class="hidden card-lowes p-8 big-shadow mt-6">
        <h2 class="text-3xl font-semibold mb-6" style="color: var(--lowes-blue);">æ§åˆ¶å°</h2>

        <div class="grid grid-cols-3 gap-4 mb-6" id="adminStats">
          <div class="p-6 border-2 rounded-xl text-center" style="border-color: var(--lowes-blue);">
            <div class="text-3xl font-bold mb-2" style="color: var(--lowes-blue);" id="statTotal">0</div>
            <div class="text-sm font-semibold" style="color: var(--lowes-gray);">æŠ¥åäººæ•°</div>
          </div>
          <div class="p-6 border-2 rounded-xl text-center" style="border-color: var(--lowes-blue);">
            <div class="text-3xl font-bold mb-2" style="color: var(--lowes-blue);" id="statQ1">0</div>
            <div class="text-sm font-semibold" style="color: var(--lowes-gray);">ç¬¬1é¢˜æäº¤</div>
          </div>
          <div class="p-6 border-2 rounded-xl text-center" style="border-color: var(--lowes-blue);">
            <div class="text-3xl font-bold mb-2" style="color: var(--lowes-blue);" id="statQ2">0</div>
            <div class="text-sm font-semibold" style="color: var(--lowes-gray);">ç¬¬2é¢˜æäº¤</div>
          </div>
        </div>

        <div class="flex flex-wrap gap-3 mb-6">
          <button id="btnInit" class="px-5 py-3 rounded-lg font-semibold" style="background-color: #e0e0e0; color: #333;">ä¸€é”®åˆå§‹åŒ–</button>
          <button id="btnStartQ1" class="btn-lowes-primary px-5 py-3 rounded-lg font-semibold">å¼€æ”¾ç¬¬1é¢˜</button>
          <button id="btnEndQ1Draw" class="btn-lowes-secondary px-5 py-3 rounded-lg font-semibold">ç»“æŸç¬¬1é¢˜å¹¶æŠ½å¥–</button>
          <button id="btnStartQ2" class="btn-lowes-primary px-5 py-3 rounded-lg font-semibold">å¼€å§‹ç¬¬2é¢˜</button>
          <button id="btnEndAll" class="btn-lowes-secondary px-5 py-3 rounded-lg font-semibold">ç»“æŸæ´»åŠ¨</button>
          <button id="btnResetWinner" class="px-5 py-3 rounded-lg font-semibold" style="background-color: #9c27b0; color: white;">æ¸…ç©ºè·å¥–æ˜¾ç¤º</button>
          <button id="btnExport" class="px-5 py-3 rounded-lg font-semibold" style="background-color: #424242; color: white;">å¯¼å‡º CSV</button>
        </div>

        <div class="mt-6 p-6 rounded-xl" style="background: linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%); border: 2px solid var(--lowes-red);">
          <div class="text-xl font-bold" style="color: var(--lowes-red);">ğŸ‰ å½“å‰è·å¥–è€…ï¼š<span class="winnerName font-extrabold"></span></div>
        </div>

        <div class="mt-6 text-sm text-gray-500">
          <div>å¤§å±å¹•åœ°å€ï¼š<code>?mode=screen</code></div>
          <div>ç®¡ç†å‘˜åœ°å€ï¼š<code>?mode=admin</code></div>
          <div>å‚ä¸è€…ï¼ˆæ‰«ç åé»˜è®¤é¡µï¼‰ï¼š<code>æ— å‚æ•°</code></div>
        </div>
      </div>
    </section>

    <footer class="mt-10 text-center text-sm" style="color: var(--lowes-gray);">
      <div>Lowe's ç­”é¢˜æ´»åŠ¨ç³»ç»Ÿ | ä¸€æ¬¡æ€§æ´»åŠ¨ä½¿ç”¨</div>
    </footer>
  </div>

  <!-- ä¸šåŠ¡è„šæœ¬ï¼šLeanCloud ç‰ˆï¼Œæ— è°·æ­Œä¾èµ– -->
  <script>
    // ==============================
    // 1) å¡«å†™ä½ çš„ LeanCloud é…ç½®ï¼ˆä¸­å›½åŒº / å›½é™…åŒºäºŒé€‰ä¸€ï¼‰
    //    å»ºè®®ç”¨ä¸­å›½åŒºï¼ˆlc-cn ç»“å°¾ï¼‰ã€‚
    //    ç™»å½• LeanCloud æ§åˆ¶å° -> åº”ç”¨ Keys -> è·å¾— appId/appKey/serverURL
    //    
    //    é‡è¦ï¼šé…ç½®æ­¥éª¤
    //    1. è®¿é—® https://leancloud.cn/ ç™»å½•æ‚¨çš„è´¦å·
    //    2. åˆ›å»ºåº”ç”¨ï¼ˆé€‰æ‹©ä¸­å›½åŒºèŠ‚ç‚¹ï¼‰
    //    3. è¿›å…¥åº”ç”¨ -> è®¾ç½® -> åº”ç”¨ Keys
    //    4. å¤åˆ¶ App IDã€App Keyã€Server URL å¹¶å¡«å†™åˆ°ä¸‹æ–¹
    // ==============================
    const LC_APP_ID = 'MOmsJ8zedWpUtgbcDm1d6k0M-gzGzoHsz';
    const LC_APP_KEY = 'oS84Mf2RlylsrirPZ0uzKzG2';
    const LC_SERVER_URLS = 'https://momsj8ze.lc-cn-n1-shared.com';

    // åˆå§‹åŒ– LeanCloud
    AV.init({ appId: LC_APP_ID, appKey: LC_APP_KEY, serverURLs: LC_SERVER_URLS });

    // ç®¡ç†å‘˜å£ä»¤ï¼ˆä¸€æ¬¡æ€§æ´»åŠ¨ç”¨ï¼Œå»ºè®®ä¿®æ”¹ä¸ºæ›´å®‰å…¨çš„å¯†ç ï¼‰
    const ADMIN_CODE = '8888';

    // ==============================
    // 2) é¢˜ç›®è®¾ç½®ï¼ˆè‡ªè¡Œæ›¿æ¢ä¸ºç°åœºé¢˜ç›®ä¸é€‰é¡¹ï¼‰
    //    è¯·æ ¹æ®å®é™…æ´»åŠ¨å†…å®¹ä¿®æ”¹é¢˜ç›®å’Œé€‰é¡¹
    // ==============================
    const QUESTIONS = {
      q1: {
        title: 'ç¬¬1é¢˜ï¼šä»Šå¤©ä¸»æŒäººç©¿çš„è¡£æœé¢œè‰²æ˜¯ï¼Ÿ',
        options: ['çº¢è‰²', 'è“è‰²', 'é»‘è‰²', 'ç™½è‰²'],
      },
      q2: {
        title: 'ç¬¬2é¢˜ï¼šæœ¬æ¬¡æ´»åŠ¨åœ°ç‚¹åœ¨ï¼Ÿ',
        options: ['Aå…', 'Bå…', 'Cå…', 'Då…'],
      },
    };

    // ==============================
    // 3) ç®€æ˜“çŠ¶æ€ä¸æ•°æ®ç»“æ„ï¼ˆLeanCloud Classesï¼‰
    //    Class: Meta(key, phase, winnerPid, ts)
    //           phase: 'name' | 'q1' | 'draw1' | 'q2' | 'done'
    //    Class: Participant(pid, name, createdAt)
    //    Class: Answer(pid, name, q1, q2, updatedAt)
    // ==============================

    // DOM å¿«æ·
    const $ = sel => document.querySelector(sel);
    const byId = id => document.getElementById(id);
    const sleep = ms => new Promise(r => setTimeout(r, ms));

    function uuid() {
      if (crypto?.randomUUID) return crypto.randomUUID();
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
        const r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    function ensurePid() {
      let pid = localStorage.getItem('pid');
      if (!pid) { pid = uuid(); localStorage.setItem('pid', pid); }
      return pid;
    }

    function getQueryParam(name) {
      return new URLSearchParams(location.search).get(name);
    }

    // è§†å›¾å¼•ç”¨
    const viewJoin = byId('view-join');
    const viewQ1 = byId('view-q1');
    const viewQ2 = byId('view-q2');
    const viewWait = byId('view-wait');
    const viewScreen = byId('view-screen');
    const viewAdmin = byId('view-admin');

    const nameInput = byId('nameInput');
    const nameBtn = byId('nameBtn');

    const q1Title = byId('q1Title');
    const q1Opts = byId('q1Opts');
    const q2Title = byId('q2Title');
    const q2Opts = byId('q2Opts');

    const screenQR = byId('screenQR');
    const screenMsg = byId('screenMsg');

    const adminCodeInput = byId('adminCode');
    const adminGate = byId('adminGate');
    const adminPanel = byId('adminPanel');

    const btnInit = byId('btnInit');
    const btnStartQ1 = byId('btnStartQ1');
    const btnEndQ1Draw = byId('btnEndQ1Draw');
    const btnStartQ2 = byId('btnStartQ2');
    const btnEndAll = byId('btnEndAll');
    const btnResetWinner = byId('btnResetWinner');
    const btnExport = byId('btnExport');

    const winnerNameSpans = document.querySelectorAll('.winnerName');

    function showOnly(el) {
      [viewJoin, viewQ1, viewQ2, viewWait, viewScreen, viewAdmin].forEach(v => v?.classList.add('hidden'));
      el && el.classList.remove('hidden');
    }

    function renderQuestion(titleEl, optsEl, qKey) {
      const q = QUESTIONS[qKey];
      titleEl.textContent = q.title;
      optsEl.innerHTML = '';
      q.options.forEach(opt => {
        const btn = document.createElement('button');
        btn.className = 'option-btn w-full my-3 px-6 py-4 rounded-lg text-lg font-semibold';
        btn.style.cssText = 'border: 2px solid #e0e0e0; transition: all 0.3s ease;';
        btn.textContent = opt;
        btn.onclick = () => submitAnswer(qKey, opt);
        optsEl.appendChild(btn);
      });
    }

    function renderScreenQR() {
      screenQR.innerHTML = '';
      const joinUrl = `${location.origin}${location.pathname}`; // æ— å‚å³å‚ä¸ç«¯
      // å¤§å±å¹•æ˜¾ç¤ºï¼ŒäºŒç»´ç å°ºå¯¸è°ƒå¤§
      new QRCode(screenQR, { text: joinUrl, width: 280, height: 280, colorDark: '#004990', colorLight: '#ffffff' });
    }

    async function playConfetti() {
      try {
        const duration = 1500; const end = Date.now() + duration;
        (function frame() {
          confetti({ particleCount: 3, angle: 60, spread: 55, origin: { x: 0 } });
          confetti({ particleCount: 3, angle: 120, spread: 55, origin: { x: 1 } });
          if (Date.now() < end) requestAnimationFrame(frame);
        })();
      } catch(e) {}
    }

    async function showWinnerName(name) {
      winnerNameSpans.forEach(sp => sp.textContent = name || '');
      if (name) await playConfetti();
    }

    // ===== LeanCloud æ•°æ®å°è£… =====
    async function upsertParticipant(pid, name) {
      const Participant = AV.Object.extend('Participant');
      const query = new AV.Query('Participant');
      query.equalTo('pid', pid);
      const exist = await query.first();
      if (exist) {
        exist.set('name', name);
        exist.set('createdAtMs', Date.now());
        return exist.save();
      } else {
        const obj = new Participant();
        obj.set('pid', pid);
        obj.set('name', name);
        obj.set('createdAtMs', Date.now());
        return obj.save();
      }
    }

    async function getParticipantByPid(pid) {
      const q = new AV.Query('Participant');
      q.equalTo('pid', pid);
      return q.first();
    }

    async function upsertAnswer(pid, name, patch) {
      const Answer = AV.Object.extend('Answer');
      const q = new AV.Query('Answer');
      q.equalTo('pid', pid);
      let obj = await q.first();
      if (!obj) obj = new Answer();
      obj.set('pid', pid);
      obj.set('name', name);
      Object.keys(patch).forEach(k => obj.set(k, patch[k]));
      obj.set('updatedAtMs', Date.now());
      return obj.save();
    }

    async function countAnswers(hasField) {
      const q = new AV.Query('Answer');
      q.exists(hasField);
      return q.count();
    }

    async function countParticipants() {
      const q = new AV.Query('Participant');
      return q.count();
    }

    // Meta: å•è¡Œï¼Œkey='state'
    async function ensureMeta() {
      const q = new AV.Query('Meta');
      q.equalTo('key', 'state');
      let m = await q.first();
      if (!m) {
        const Meta = AV.Object.extend('Meta');
        m = new Meta();
        m.set('key', 'state');
        m.set('phase', 'name');
        m.set('winnerPid', null);
        m.set('ts', Date.now());
        await m.save();
      }
      return m;
    }

    async function getMeta() {
      const q = new AV.Query('Meta');
      q.equalTo('key', 'state');
      return q.first();
    }

    async function setPhase(phase) {
      const m = await ensureMeta();
      m.set('phase', phase);
      m.set('ts', Date.now());
      await m.save();
    }

    async function setWinner(pidOrNull) {
      const m = await ensureMeta();
      m.set('winnerPid', pidOrNull || null);
      m.set('ts', Date.now());
      await m.save();
    }

    async function drawFromAnswered(which='q1') {
      // ä»å·²æäº¤å¯¹åº”é¢˜ç›®çš„ç”¨æˆ·ä¸­æŠ½å–
      const q = new AV.Query('Answer');
      q.exists(which);
      q.limit(1000);
      const list = await q.find();
      if (!list.length) { alert('æš‚æ— æäº¤ï¼Œæ— æ³•æŠ½å¥–'); return null; }
      const idx = Math.floor(Math.random() * list.length);
      const winner = list[idx];
      const pid = winner.get('pid');
      await setWinner(pid);
      const p = await getParticipantByPid(pid);
      const name = p ? (p.get('name') || 'æœªç•™å') : 'æœªç•™å';
      alert(`ä¸­å¥–è€…ï¼š${name}`);
      return pid;
    }

    async function exportCSV() {
      const pQ = new AV.Query('Participant'); pQ.limit(1000); const ps = await pQ.find();
      const aQ = new AV.Query('Answer'); aQ.limit(1000); const as = await aQ.find();
      const amap = new Map(as.map(o => [o.get('pid'), o]));
      const rows = [["pid","name","q1","q2","updatedAtMs"]];
      ps.forEach(p => {
        const pid = p.get('pid');
        const name = p.get('name') || '';
        const a = amap.get(pid);
        rows.push([
          pid,
          name,
          a ? (a.get('q1') || '') : '',
          a ? (a.get('q2') || '') : '',
          a ? (a.get('updatedAtMs') || '') : ''
        ]);
      });
      const csv = rows
        .map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(','))
        .join('\n');
      const blob = new Blob(["ï»¿" + csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `quiz_export_${Date.now()}.csv`;
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // ===== å‚ä¸ç«¯äº¤äº’ =====
    async function submitName() {
      const name = nameInput.value.trim();
      if (!name) return alert('è¯·å…ˆå¡«å†™å§“å');
      const pid = ensurePid();
      await upsertParticipant(pid, name);
      localStorage.setItem('name', name);
      byId('yourName').textContent = name;
      alert('æäº¤æˆåŠŸï¼Œç­‰å¾…ä¸»æŒäººå¼€å§‹ç¬¬1é¢˜â€¦');
      showOnly(viewWait);
    }

    async function submitAnswer(qKey, value) {
      const pid = ensurePid();
      const name = localStorage.getItem('name') || '';
      if (!name) { alert('è¯·å…ˆå¡«å†™å§“å'); return showOnly(viewJoin); }
      const patch = {}; patch[qKey] = value;
      await upsertAnswer(pid, name, patch);
      alert('å·²æäº¤âœ…');
    }

    // ===== è½®è¯¢æ›´æ–°ï¼ˆé¿å…é¢å¤–å®æ—¶åº“ï¼Œè¶³å¤Ÿä¸€æ¬¡æ€§æ´»åŠ¨ï¼‰ =====
    async function refreshUI(mode) {
      const meta = await getMeta();
      const phase = meta ? meta.get('phase') : 'name';
      const winnerPid = meta ? meta.get('winnerPid') : null;

      // å…¬å…±ç»Ÿè®¡
      const [total, q1c, q2c] = await Promise.all([
        countParticipants(),
        countAnswers('q1'),
        countAnswers('q2'),
      ]);
      byId('statTotal') && (byId('statTotal').textContent = String(total));
      byId('statQ1') && (byId('statQ1').textContent = String(q1c));
      byId('statQ2') && (byId('statQ2').textContent = String(q2c));
      byId('screenTotal') && (byId('screenTotal').textContent = String(total));
      byId('screenQ1') && (byId('screenQ1').textContent = String(q1c));
      byId('screenQ2') && (byId('screenQ2').textContent = String(q2c));

      if (mode === 'screen') {
        const map = { name: 'æ‰«ç æŠ¥åï¼Œå¡«å†™å§“å', q1: 'ç¬¬1é¢˜è¿›è¡Œä¸­â€¦', draw1: 'æŠ½å¥–ä¸­â€¦', q2: 'ç¬¬2é¢˜è¿›è¡Œä¸­â€¦', done: 'æ´»åŠ¨ç»“æŸï¼Œè°¢è°¢å‚ä¸ï¼' };
        byId('screenMsg').textContent = map[phase] || 'ç­‰å¾…å¼€å§‹â€¦';

        if (winnerPid) {
          const p = await getParticipantByPid(winnerPid);
          const name = p ? (p.get('name') || 'æœªç•™å') : 'æœªç•™å';
          await showWinnerName(name);
        } else {
          await showWinnerName('');
        }
      }

      if (mode === 'join') {
        const name = localStorage.getItem('name');
        if (!name) { showOnly(viewJoin); return; }
        byId('yourName').textContent = name;
        if (phase === 'name') showOnly(viewWait);
        else if (phase === 'q1') { renderQuestion(q1Title, q1Opts, 'q1'); showOnly(viewQ1); }
        else if (phase === 'draw1') showOnly(viewWait);
        else if (phase === 'q2') { renderQuestion(q2Title, q2Opts, 'q2'); showOnly(viewQ2); }
        else if (phase === 'done') { showOnly(viewWait); byId('waitMsg').textContent = 'æ´»åŠ¨å·²ç»“æŸï¼Œæ„Ÿè°¢å‚ä¸ï¼'; }
      }
    }

    function startPolling(mode) {
      refreshUI(mode);
      setInterval(() => refreshUI(mode), 2000); // 2 ç§’ä¸€è½®
    }

    // ===== å¯åŠ¨å…¥å£ =====
    function boot() {
      const mode = (getQueryParam('mode') || '').toLowerCase();
      nameBtn.onclick = submitName;

      if (mode === 'screen') {
        showOnly(viewScreen); renderScreenQR(); startPolling('screen'); return;
      }

      if (mode === 'admin') {
        showOnly(viewAdmin);
        adminGate.classList.remove('hidden');
        adminPanel.classList.add('hidden');
        byId('adminEnter').onclick = async () => {
          if (adminCodeInput.value === ADMIN_CODE) {
            adminGate.classList.add('hidden');
            adminPanel.classList.remove('hidden');
            // ç»‘å®šæŒ‰é’®
            btnInit.onclick = async () => { await ensureMeta(); alert('åˆå§‹åŒ–å®Œæˆ'); };
            btnStartQ1.onclick = () => setPhase('q1');
            btnEndQ1Draw.onclick = async () => { await setPhase('draw1'); await sleep(400); await drawFromAnswered('q1'); };
            btnStartQ2.onclick = () => setPhase('q2');
            btnEndAll.onclick = () => setPhase('done');
            btnResetWinner.onclick = () => setWinner(null);
            btnExport.onclick = exportCSV;
            startPolling('admin');
          } else {
            alert('å£ä»¤é”™è¯¯');
          }
        };
        return;
      }

      // é»˜è®¤ï¼šå‚ä¸ç«¯
      showOnly(viewJoin);
      const name = localStorage.getItem('name');
      if (name) { byId('yourName').textContent = name; showOnly(viewWait); }
      startPolling('join');
    }

    window.addEventListener('DOMContentLoaded', boot);
  </script>
</body>
</html>
